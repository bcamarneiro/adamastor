name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true

jobs:
  verify-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: staging

      - name: Check CI status on staging
        run: |
          # Get latest commit on staging
          COMMIT=$(git rev-parse HEAD)
          echo "Checking CI status for commit: $COMMIT"

          # Check if CI passed
          STATUS=$(gh api repos/${{ github.repository }}/commits/$COMMIT/check-runs --jq '.check_runs | map(select(.conclusion == "success")) | length')
          TOTAL=$(gh api repos/${{ github.repository }}/commits/$COMMIT/check-runs --jq '.check_runs | length')

          echo "Passed checks: $STATUS / $TOTAL"

          if [ "$STATUS" != "$TOTAL" ] || [ "$TOTAL" = "0" ]; then
            echo "::error::Not all CI checks passed on staging"
            exit 1
          fi
          echo "All CI checks passed"
        env:
          GH_TOKEN: ${{ github.token }}

  confirm-deployment:
    runs-on: ubuntu-latest
    needs: verify-tests
    steps:
      - name: Verify confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy" ]; then
            echo "::error::You must type 'deploy' to confirm"
            exit 1
          fi
          echo "Deployment confirmed"

  merge-to-main:
    runs-on: ubuntu-latest
    needs: confirm-deployment
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge staging to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin staging
          git merge origin/staging --no-edit -m "chore: merge staging to main for production deploy"
          git push origin main

  deploy-db-production:
    runs-on: ubuntu-latest
    needs: merge-to-main
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to production project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy migrations to production
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
