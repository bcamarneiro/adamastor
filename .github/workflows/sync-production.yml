name: Sync Production

on:
  schedule:
    - cron: "0 7 * * *" # Daily at 7 AM UTC (1h after staging)
  workflow_dispatch:
    inputs:
      force:
        description: "Force full sync (ignore hash comparison)"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest
    environment: production # Requires approval if configured in GitHub settings

    steps:
      # Checkout the latest release tag, not main
      - name: Get latest release tag
        id: latest_release
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            if (releases.data.length === 0) {
              console.log('‚ö†Ô∏è No releases found. Skipping production sync.');
              console.log('Create a release first before production can sync.');
              core.setOutput('skip', 'true');
              return;
            }
            const tag = releases.data[0].tag_name;
            core.setOutput('tag', tag);
            core.setOutput('skip', 'false');
            console.log(`Using release: ${tag}`);

      - uses: actions/checkout@v4
        if: steps.latest_release.outputs.skip != 'true'
        with:
          ref: ${{ steps.latest_release.outputs.tag }}

      - uses: oven-sh/setup-bun@v2
        if: steps.latest_release.outputs.skip != 'true'
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.latest_release.outputs.skip != 'true'
        run: bun install
        working-directory: apps/watcher

      # Cache snapshots directory to speed up re-runs and debugging
      - name: Cache snapshots
        if: steps.latest_release.outputs.skip != 'true'
        uses: actions/cache@v4
        with:
          path: apps/watcher/snapshots
          key: sync-snapshots-production-${{ github.run_id }}
          restore-keys: |
            sync-snapshots-production-

      - name: Sync to production
        if: steps.latest_release.outputs.skip != 'true'
        id: sync
        env:
          B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
          B2_APP_KEY: ${{ secrets.B2_APP_KEY }}
          B2_BUCKET: ${{ secrets.B2_BUCKET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          ENVIRONMENT: production
        run: |
          if [ "${{ inputs.force }}" = "true" ]; then
            echo "üîÑ Force mode enabled - running full sync"
            bun run start -- --force
          else
            bun run start
          fi
        working-directory: apps/watcher

      # Smoke test - verify data was synced
      - name: Smoke test - verify deputies exist
        if: steps.latest_release.outputs.skip != 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "üîç Running smoke tests..."

          # Check deputies table has data
          DEPUTY_COUNT=$(curl -s \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            "$SUPABASE_URL/rest/v1/deputies?select=id&is_active=eq.true&limit=1" \
            -H "Prefer: count=exact" \
            -w "\n%{http_code}" | tail -1)

          if [ "$DEPUTY_COUNT" != "200" ]; then
            echo "‚ùå Failed to query deputies table (HTTP $DEPUTY_COUNT)"
            exit 1
          fi

          # Check deputy_stats has data
          STATS_COUNT=$(curl -s \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            "$SUPABASE_URL/rest/v1/deputy_stats?select=id&limit=1" \
            -w "\n%{http_code}" | tail -1)

          if [ "$STATS_COUNT" != "200" ]; then
            echo "‚ùå Failed to query deputy_stats table (HTTP $STATS_COUNT)"
            exit 1
          fi

          echo "‚úÖ Smoke tests passed"

      - name: Notify on failure
        if: failure() && steps.latest_release.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Production sync failed - ${new Date().toISOString().split('T')[0]}`,
              body: `The production sync workflow failed.\n\nRelease: ${{ steps.latest_release.outputs.tag }}\nRun: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'sync', 'production']
            });
